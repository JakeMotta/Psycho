<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Psycho</title>

<link href="https://fonts.googleapis.com/css?family=Amatic+SC" rel="stylesheet">

<style>
	#container {
		width: 640px;
		background-color: transparent;
		margin: auto;
		min-height: 10px;
		padding-top: 75px;
	}
	#nameBox {
		width:100%;
		min-height:5px;
		background-color: transparent;
		margin: auto;
	}
	#myForm {
		margin: auto;
		text-align: center;
	}
	#myForm2 {
		margin: auto;
		text-align: center;
		margin-top: 15px;
	}
	#userInput {
		width:640px;
		min-height: 25px;
		background-color: transparent;
		text-align: center;
		margin: auto;
		margin-top: 15px;
	}
	#content {
		width: 640px;
		min-height: 50px;
		background-color: transparent;
		margin: auto;
	}
	#howto {
		width:310px;
		min-height: 25px;
		background-color: transparent;
		text-align: left;
		margin: auto;
		float:left;
		border-right:1px solid black;
		padding-right: 5px;
	}
	#highscore_div {
		width:310px;
		min-height: 25px;
		background-color: transparent;
		margin: auto;
		float: left;
		padding-left: 5px;
	}
	#footer {
		width:100%;
		height: 0px;
		clear: both;
	}
	.largeText {
		font-size: 64px;
		text-align: center;
	}
	.medText {
		font-size: 48px;
		text-align: center;
	}
	.smallText {
		font-size: 32px;
		text-align: center;
	}
	.text {
		font-size: 18px;
		text-align: center;
	}
	.amatic {
		font-family: 'Amatic SC', cursive;
	}
	.arial {
		font-family: 'Arial';
	}
	.bold {
		font-weight: bold;
	}
	.underline {
		text-decoration: underline;
	}
	.red {
		color:red;
	}
	input[type=text], select {
		width: 200px;
		display: inline-block;
		border: 1px solid #ccc;
		border-radius: 4px;
		box-sizing: border-box;
	}

	button[type=submit] {
		width: 150px;
		height: 45px;
		background-color: #4CAF50;
		color: white;
		padding: -10px 0px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		margin-left: 25px;
	}

	button[type=submit]:hover {
		background-color: #45a049;
	}
	#scoreTable {
		width:100%;
		min-height: 10px;
		background-color: transparent;
	}
	.scoreRow {
		width:100%;
		height: 30px;
		background-color: transparent;
	}
	.scoreDataLeft {
		width:50%;
		height: 10px;
		padding-right: 15px;
		background-color: transparent;
		text-align: right;
	}
	.scoreDataRight {
		width:50%;
		height: 10px;
		padding-left: 15px;
		background-color: transparent;
	}
</style>

</head>

<body>

<div id="container">
	<canvas id="context" width="640" height="640" style="border: 2px solid black"></canvas>
</div>

<div id="nameBox">

	<!-- Username input box -->
	<div id="userInput">
		<form method="post" name="playerForm" id="myForm">
				  <div class="form-group">
					<label for="name" class="smallText amatic">Name: </label>
					<input type="text" class="form-control smallText amatic" id="name" required placeholder="Enter username">
					<button type="submit" value="Submit" onclick="getPlayerName(); return false;" class="btn btn-primary addValue smallText amatic">Submit</button>
				  </div>
		</form>
		
		<br><br>
	</div>
	
	<div id="content">
		<div id="howto">
			<span class="medText amatic bold underline">How to Start:</span>
			
			<span class="text arial"> 
				<br><br> Step 1: Type username above <br> Step 2: Click black sqaure <br><br> 

				<span class="medText amatic bold underline">Instructions:</span> <br><br>
				You have a total of <span class="red bold">5 minutes</span> to get as many clicks as possible in... but that's too easy. 

				<br><br> <span class="red bold">You can't click any later</span> than 10 seconds per click, and <span class="red bold">you can't press any sooner</span>  than... well... sometime between 8 seconds and 3 seconds per click. 

				<br><br> I'm not sure too be honest. That part, I'll leave up to you. 
				
				<br><br> <span class="red bold">The goal of this game</span> is to fight against yourself in determining when the best time to click would be. You can always get a <span class="red bold">successful click at 3 seconds or below</span>, but you'll never reach the top of the leaderboards if you're too cautious!
			</span>
		</div>

		<div id="highscore_div">
			<div align="right"><span class="largeText amatic bold ">Leaderboard:</span> <span class="smallText amatic"> (Top 15)</span></div>
			<table id="scoreTable">
				<tr class="scoreRow"><td class="scoreDataLeft"><span class="smallText amatic bold">Player:</span></td><td class="scoreDataRight"><span class="smallText amatic bold">Score:</span></td></tr>
			</table>
		</div>
		<div id="footer"></div>
	</div>
	
	<!-- AUDIO -->
	<audio id="successSound" src="successButton2.mp3"></audio>
	<audio id="submitSound" src="submitClick3.mp3"></audio>
	<audio id="gameOverSound" src="gameOver.mp3"></audio>
	<audio id="mainMusic" src="108_game.mp3" loop></audio>

</div>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
				 
<!-- Latest compiled and minified Bootstrap -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/3.9.0/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.9.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.9.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.9.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.9.0/firebase-messaging.js"></script>
<script src="https://cdn.firebase.com/js/client/2.2.1/firebase.js"></script>
		 
<!-- Include Firebase Library -->
<script src="https://cdn.firebase.com/js/client/2.2.3/firebase.js"></script>
	
<script>
	// Firebase reference from http://time2hack.com/2015/03/intro-to-firebase-with-javascript-and-jquery.html
	
	// Initialize Firebase
	var config = {
	  apiKey: "AIzaSyAu1NVukUsb3gj1UTGxkuf-hu__aar3dc8",
	  authDomain: "psycho-c05a2.firebaseapp.com",
	  databaseURL: "https://psycho-c05a2.firebaseio.com",
	  projectId: "psycho-c05a2",
	  storageBucket: "psycho-c05a2.appspot.com",
	  messagingSenderId: "435872665747"
	};
	firebase.initializeApp(config);
	
	//create firebase reference
	var dbRef = new Firebase("https://psycho-c05a2.firebaseio.com");
	var playerRef = dbRef.child('psychoPlayers');

	// user's unique player ID
	var playerID;
	
	//load older conatcts as well as any newly added one...
	playerRef.on("child_added", function(snap) {
	  //console.log("key:" + snap.key() + ", val:" + snap.val());
	  playerID = snap.key();
	  document
		.querySelector('#name')
		.innerHTML += contactHtmlFromObject(snap.val());
	});

	//save contact
	document
	  .querySelector('.addValue')
	  .addEventListener("click", function( event ) {  
		event.preventDefault();
		
		var myName = document.querySelector('#name').value;
		
		if(checkNameRules(myName)) {
		  playerRef
			.push({
			  playerName: myName,
			  playerScore: pScore,
			})
			playerForm.reset();
		} else {
		  alert('Please enter a username. Must be between 3 and 15 characters.');
		}
	  }, false);

	//prepare conatct object's HTML
	function contactHtmlFromObject(psychoPlayers) { 
	  //console.log( psychoPlayers ); 
	  var html = ''; 
	  html += '<li class="list-group-item psychoPlayers">'; 
		  html += '<span id="smallText">'+psychoPlayers.name+'</span>'; 
	  html += '</li>'; 
	  return html; 
	} 
	
	//update contact
	function updateScore() {
		playerRef.on("child_added", function(snap) {
			
			//scrub through users
			snap.forEach(function(childSnapshot) {
				var key = childSnapshot.key();
				var childData = childSnapshot.val();	
				
				//display user ID and current ID in loop
				//console.log("key:" + snap.key() + ", data:" + playerID)
				
				if(snap.key() == playerID) {
					//console.log("MATCH!")
					playerRef.child(snap.key()).set({
						"playerName" : pName,
						"playerScore" : pScore
					});
				}
			});
		});
	}
	
	// get leaderboard results
	function getLeaderboard() {
		
		var leaderboard_score = [];
		var leaderboard_name = [];
		
		// i is for going through name/score, j is for going through the arrays
		var i = 0, j = 0, k = 0;
		
		playerRef.on("child_added", function(snap) {
			
			//scrub through users
			snap.forEach(function(childSnapshot) {
				
				var key = childSnapshot.key();
				var childData = childSnapshot.val();
				
				// switch between assigning name or score
				if(i % 2 == 0) {
					leaderboard_name[j] = childData;
				} else {
					leaderboard_score[j] = childData;
					j++;
				}
								
				i++;
				
			})
		});
				
		/**
			for(k = 0; k < leaderboard_name.length; k++) {
				console.log("lead_name: " + leaderboard_name[k] + ", lead_score: " + leaderboard_score[k]);
			}
		**/
		
		// Call to sort leaderboard results
		sortLeaderboard(leaderboard_name, leaderboard_score);
	}
	
	// Sort leaderboard results (Max -> Min)
	function sortLeaderboard(leaderboard_name, leaderboard_score) {
		var i, j, max;
		var temp_name, temp_score = 0;
		var arrSize = leaderboard_name.length;
		var sorted_name = [], sorted_score = [];

		for(i = 0; i < arrSize - 1; i++) {
			
			max = i;
			
			for(j = i + 1; j < arrSize; j++) {
				if(leaderboard_score[j] > leaderboard_score[max]) {
					max = j;
				}
			}
			
			if(max != i) {
				temp_name = leaderboard_name[max];
				temp_score = leaderboard_score[max];
				
				leaderboard_name[max] = leaderboard_name[i];
				leaderboard_score[max] = leaderboard_score[i];
				
				leaderboard_name[i] = temp_name;
				leaderboard_score[i] = temp_score;
			}
		}
		
		// Call to display leaderboard results
		document
		.querySelector('#scoreTable')
		.innerHTML += displayLeaderboard(leaderboard_name, leaderboard_score);
	}
	
	// Display leaderboard results
	function displayLeaderboard(leaderboard_name, leaderboard_score) {
		var leaderboard = ''; 
		var i, j;
		var maxDisplay = 15;
		
		for(i = 0; i < leaderboard_name.length; i++) {
			if(i < maxDisplay) // Display only certain number of results
			leaderboard += '<tr class="scoreRow"><td class="scoreDataLeft"><span class="smallText amatic">' + leaderboard_name[i] + ': ' + '</span></td><td class="scoreDataRight"><span class="smallText amatic">' + leaderboard_score[i] + '</span></td></tr>';
			else 
				return leaderboard;
		}
		
		return leaderboard; 
	}
	
	// Send highscore to database variable
	function sendHighScore() { 
		pScore = player.highScore;
		updateScore();
	 }
	
	// Get player name from input box
	function getPlayerName() { 
		pName = document.getElementById('name').value;
		audioClip("submitSound");
		getLeaderboard();
	 }
	
	// Checks name creation rules
	function checkNameRules(name) {
		if(name != '' && name != null && name != '' && name != "" && name.length >= 3 && name.length <= 15 && /^[0-9a-zA-Z]+$/.test(name))
			return true;
		else 
			return false;
	}

</script>

<script>
	var elem = document.getElementById('context'),
    elemLeft = elem.offsetLeft,
    elemTop = elem.offsetTop,
    context = elem.getContext('2d'),
    elements = [];
	
	// Game speed
	setInterval(update, 100);

	// -------------------------------------   GAME OBJECTS   -------------------------------------------------
	
	// Canvas Width/Height/Colors
	var cWidth = 640;
	var cHeight = 640;
	var canvasTimer = 0;
	var tT = 0; // Time timer
	
	// Game variables
	var gameOver = true;
	var isGameOverScreen = false;
	var canClick = false;
	var isSuccess = false;
	var successTimer = 0;
	var audioTimer = 0;
	var audioTimer_GO = 0;
	
	//DB Player info
	var pScore = 0; // Player score to send to database
	var pName = null; // Player name to send to database
	var hasUsername = false; // Has the player set a username?
	

	// Rect Info
	elements.push({
		myFill:'black',
		width: 74,
		height: 74,
		top: 400,
		left: 283
	});
	
	// Game Title
	var gameTtle = {
		myFill:'red',
		font:'128px Amatic SC, cursive',
		name:"Psycho!",
		x:200,
		y:225
	};
	
	// Large Text
	var largeText = {
		myFill:'#555555',
		font:'36px Arial'
	};
	
	// Normal Text
	var medText = {
		myFill:'#555555',
		font:'24px Arial'
	};
	
	// Small Text
	var smallText = {
		myFill:'#555555',
		font:'12px Arial'
	};
	
	// Total Time for game
	var gameTimer = {
 		time:300,
		myFill:'black',
		default:300
	};
	
	// Time left to clik
	var clickMax = {
		default:10,
 		time:10,
		myFill:'black',
	};
	
	// Time until player can clik
	var clickMin = {
		default:6,
 		time:6,
		maxNum:6,
		myFill:'black',
	};
	
	// Time until start menu
	var resetTime = {
		default:3,
 		time:3,
		myFill:'black',
	};
	
	// Player points
	var player = {
		points:0,
		highScore:0
	};
	
	// successful click
	var successClick = {
		font:'24px Arial',
		myFill:'black',
		vsp:3,
		y:300, 
		rando:5,
		defaultY:300
	};
	
	// -------------------------------------   FUNCTIONS   -------------------------------------------------
	
	// Game-start splash screen
	function gameStartScreen() {
		context.clearRect(0,0,cWidth,cHeight);
		
		// Reset gameover sound
		audioTimer_GO = 0;
		
		context.font = gameTtle.font;
		context.fillStyle = gameTtle.myFill;
		context.fillText(gameTtle.name, gameTtle.x, gameTtle.y);
		
		context.font = medText.font;
		context.fillStyle = medText.myFill;
		context.fillText("Welcome, " + pName, 15, 35);
		
		context.font = medText.font;
		context.fillStyle = medText.myFill;
		context.fillText("Your High Score: " + player.highScore, 225, 265);

		context.font = medText.font;
		context.fillStyle = medText.myFill;
		context.fillText("Click the square to start!", 190, 500);
		
		context.font = smallText.font;
		context.fillStyle = smallText.myFill;
		context.fillText("A game by Jake Motta!", 510, 630);
		
		drawRect();
	}
	
	// Game-over splash screen display
	function gameOverScreen() {
		isGameOverScreen = true;
		
		// Play gameover sound once
		if(audioTimer_GO == 0)
			audioClip("gameOverSound");
		
		audioTimer_GO++;
		
		context.clearRect(0,0,cWidth,cHeight);
		context.font = gameTtle.font;
		context.fillStyle = gameTtle.myFill;
		context.fillText("Game Over!", 125, 350);
		
		var time = fancyTimeFormat(resetTime.time);
		
		context.fillStyle = resetTime.myFill;
		context.font = medText.font;
		context.fillText(time, 300, 400);
		
		if(tT % 10 == 0)
			resetTime.time -= 1;
		
		if(resetTime.time < 0)
			resetGame();
	}
	
	// Time output from http://stackoverflow.com/questions/3733227/javascript-seconds-to-minutes-and-seconds
	function fancyTimeFormat(time)
	{   		
		// Hours, minutes and seconds
		var hrs = ~~(time / 3600);
		var mins = ~~((time % 3600) / 60);
		var secs = time % 60;

		// Output like "1:01" or "4:03:59" or "123:03:59"
		var ret = "";

		if (hrs > 0) {
			ret += "" + hrs + ":" + (mins < 10 ? "0" : "");
		}

		ret += "" + mins + ":" + (secs < 10 ? "0" : "");
		ret += "" + secs;
		
		
		return ret;
	}
	
	// Update score
	function updatePlayer() {
		context.font = medText.font;
		context.fillText("Points: " + player.points, 500, 45);
	}

	// Draw rectangle used for clicking
	function drawRect() {
		// Render elements.
		elements.forEach(function(element) {
			context.fillStyle = element.myFill;	
			context.fillRect(element.left, element.top, element.width, element.height);
		});
	}
	
	// Update time display for gameTimer
	function updateTimer() {
		var time = fancyTimeFormat(gameTimer.time);
		
		context.fillStyle = gameTimer.myFill;	
		context.font = largeText.font;
		context.fillText(time, 25, 50);
		
		if(tT % 10 == 0)
			gameTimer.time -= 1;
	}
	
	// Update time display for clickMax
	function updateClickMax() {
		var time = fancyTimeFormat(clickMax.time);
		
		if(clickMax.time > 3)
			context.fillStyle = clickMax.myFill;	
		else
			context.fillStyle = 'red';
			
		context.font = largeText.font;
		context.fillText(time, 285, 375);
		
		if(tT % 10 == 0)
			clickMax.time -= 1;
	}
	
	// Update time display for clickMin
	function updateClickMin() {
		var time = fancyTimeFormat(clickMin.time);
		
		context.fillStyle = clickMin.myFill;
		context.font = largeText.font;
		context.fillText(time, 285, 525, 0);
		
		if(tT % 10 == 0)
			clickMin.time -= 1;
	}
	
	// Resest function
	function resetClickMin() {
		var random = Math.floor(Math.random() * clickMin.maxNum) + 1;
		clickMin.time = random;
	}
	
	// Get random number
	function getRandom(num) {
		var random = Math.floor(Math.random() * num);
		return random;
	}
	
	// Reset funtion
	function resetClickMax() {
		clickMax.time = clickMax.default;
	}

	// Check game timer. If time runs out without a click, game over!
	function checkGame() {
		if(clickMax.time <= 0) {
			checkHighScore();
			gameOverScreen();
		}
	}
	
	// Reset canvasTimer
	function resetCanvas() {
		canvasTimer = 0;
	}
	
	// What to do when the game needs to reset
	function resetGame() {
		isGameOverScreen = false;
		gameOver = true;
		resetClickMax();
		clickMin.time = clickMin.default;
		player.points = 0;
		gameTimer.time = gameTimer.default;
		resetTime.time = resetTime.default;
		resetCanvas();
	}
	
	// Create feedback messages on successful clicks
	function success() {
		successTimer += 1;
		
		context.font = successClick.font;
		context.fillStyle = successClick.myFill;
		
		successClick.y -= successClick.vsp;
		
		switch (successClick.rando) {
			case 0:
				context.fillText("RAD!", 190, successClick.y);
				break;
			case 1:
				context.fillText("NICE!", 190, successClick.y);
				break;
			case 2:
				context.fillText("GOOD JOB!", 190, successClick.y);
				break;
			case 3:
				context.fillText("SAVAGE!", 190, successClick.y);
				break;
			case 4:
				context.fillText("MOM?", 190, successClick.y);
				break;
			case 5:
				context.fillText("CS 108!", 190, successClick.y);
				break;
			case 6:
				context.fillText("おめでとう!", 190, successClick.y);
				break;
			case 7:
				context.fillText("HIRE ME!", 190, successClick.y);
				break;
			case 8:
				context.fillText("10100101", 190, successClick.y);
				break;
			case 9:
				context.fillText("DAMN DANIEL!", 190, successClick.y);
				break;
			default:
				context.fillText("SHIT!", 190, successClick.y);
				break;
		}
		
		if(successTimer >= 10) {
			isSuccess = false;
			successTimer = 0;
			successClick.y = successClick.defaultY;
			successClick.rando = getRandom(10);
		}
	}
	
	// Update canvas color based on score
	function updateCanvas() {
								
		if(canvasTimer % 30 == 0)
			canvasTimer = 0;
		
		if(canvasTimer < 5) 
			context.fillStyle = '#FFFFFF';
		
		if(canvasTimer >= 5 && canvasTimer < 10) 
			context.fillStyle = '#BAE1FF';
		
		if(canvasTimer >= 10 && canvasTimer < 15) 
			context.fillStyle = '#BAFFC9';
		
		if(canvasTimer >= 15 && canvasTimer < 20) 
			context.fillStyle = '#FFFFBA';
		
		if(canvasTimer >= 20 && canvasTimer < 25) 
			context.fillStyle = '#FFDFBA';
		
		if(canvasTimer >= 25 && canvasTimer < 30) 
			context.fillStyle = '#3BAFFF';
		
		context.fillRect(0,0,cWidth,cHeight);
	}
	
	// Check if player has entered a username
	function checkUser() {
		
		// Check username length and contents
		if(checkNameRules(pName))
			hasUsername = true;
		
		if(hasUsername == false) {
			//console.log("No name inputted");
		} else {
			//console.log("Name: " + pName);
			hasUsername = true;
		}
	}
	
	// Display for asking user for username
	function askForUsername() {
		context.clearRect(0,0,cWidth,cHeight);
		context.font = gameTtle.font;
		context.fillStyle = gameTtle.myFill;
		context.fillText(gameTtle.name, gameTtle.x, gameTtle.y);
		
		context.font = medText.font;
		context.fillStyle = gameTtle.myFill;
		context.fillText("Please enter username below to start!", 125, 600);
	}
	
	// Check if player's score is higher than any of their previous attempts
	function checkHighScore() {
		if(player.points > player.highScore) {
			player.highScore = player.points; 
			sendHighScore(); // Send highscore to DB score variable
		}
	}
	
	function audioClip(audio) {
		
		var curAudio;
		
		switch (audio) {
			case "successSound":
				curAudio = document.getElementById('successSound');
				break;
			case "submitSound":
				curAudio = document.getElementById('submitSound');
				break;
			case "gameOverSound":
				curAudio = document.getElementById('gameOverSound');
				break;
			default:
				console.log(audio + " did not play");
				break;
		}
		
		curAudio.play();
		curAudio.volume = .5;
		
	}
	
	function playMainMusic() {		
		var mainMusic = document.getElementById('mainMusic');
		mainMusic.play();
		mainMusic.volume = .7;
	}
	
	function stopMainMusic() {
		audioTimer = -1;
		document.getElementById('mainMusic').pause();
		document.getElementById('mainMusic').currentTime = 0;
	}
		
	// Main function calling for game updates
	function update() {
		
		// increase timer
		tT += 1;
		
		console.log("clickMin:" + clickMin.time);
		
		if(hasUsername == false) {
			askForUsername();
			checkUser();
		} else { 
			if(gameOver == true) {
				gameStartScreen();
				drawRect();
			} else {

				if(isGameOverScreen == false) {
					// clears the canvas each frame
					context.clearRect(0,0,cWidth,cHeight);

					updateCanvas();
					updateTimer();
					updateClickMax();
					updateClickMin();
					updatePlayer();
					checkGame();
					drawRect();

					if(isSuccess)
						success();
					
					if(audioTimer == 0)
						playMainMusic();
					
					audioTimer++;
				} else {
					stopMainMusic();
					gameOverScreen();
				}
			}
		}
	}
	
	// Clickable object reference from http://jsfiddle.net/BmeKr/
	elem.addEventListener('click', function(event) {
		var x = event.pageX - elemLeft,
			y = event.pageY - elemTop;

		elements.forEach(function(element) {
			
			// Clicked on the rect
			if (y > element.top && y < element.top + element.height && x > element.left && x < element.left + element.width) {
				
				// If on start screen
				if(gameOver) {
					gameOver = false;// Starts the game
					tT = 0; // reset timer
				} else { // If in-game					
					// Clickced on the right time
					if(clickMin.time < 0 && clickMax.time >= 0) {
						resetClickMax(); // reset max timer
						resetClickMin(); // reset minimum timer
						player.points += 1; // increase player's points
						canvasTimer += 1; // changes bg color timer
						audioClip("successSound");
						
						successClick.rando = getRandom(10);
						isSuccess = true;
					} else { // Not clicked on the right time
						
						// If the player scores higher this round than previous
						checkHighScore();
						gameOverScreen();
					}
				}
			}
		});

	}, false);

</script>
</body>
</html>